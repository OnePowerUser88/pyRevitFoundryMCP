{
    "project_name": "pyRevit Foundry MCP",
    "one_sentence_goal": "Build an MCP server and core analysis engine that scans a pyRevit extension repo and suggests/patches improvements (bundle.yaml generation, import cleanup/wrapper suggestions using a local pyRevit core clone, duplicate code detection, and lib structure proposals).",
    "non_goals": [
      "No interaction with Revit models or Revit runtime",
      "No dependency on running pyRevit; static analysis only",
      "No automatic high-risk refactors (class rewrites, moving lots of code) in V1"
    ],
    "requirements": {
      "must_have_tools": [
        "scan_extension_layout",
        "list_missing_bundle_yaml",
        "generate_bundle_yaml",
        "import_audit_with_core",
        "analyze_duplicates",
        "propose_lib_structure",
        "apply_patch"
      ],
      "should_have_tools": [
        "sys_path_audit",
        "compat_audit (no f-strings, python-compat checks)",
        "build_import_graph",
        "bundle_consistency_check"
      ],
      "nice_to_have_later": [
        "extract_to_lib (guarded refactor)",
        "suggest_class_refactors (report-only first)",
        "dead_code_finder",
        "logging_standardizer",
        "secrets_scan",
        "GitHub Action mode + SARIF output"
      ],
      "pyrevit_core_support": {
        "description": "If a local pyRevit core clone path is provided, use it as source-of-truth for wrapper/import suggestions and stamp outputs with core version (git sha). If missing, still run but mark wrapper suggestions as lower confidence.",
        "core_path_config": [
          "Support config file .pyrevit-foundry.toml with key pyrevit_core_path",
          "Also allow passing core_path directly to tools"
        ],
        "core_resources": [
          "core/version_info",
          "core/index"
        ]
      },
      "patch_workflow": [
        "All tools that can fix something must output unified diffs as patches",
        "Default is dry-run (do not write files)",
        "apply_patch supports mode: dry_run|write"
      ],
      "compat_rules": [
        "Never introduce f-strings in patches",
        "Prefer simple, explicit Python compatible syntax",
        "Keep changes minimal and localized in V1"
      ]
    },
    "architecture": {
      "packages": [
        "foundry_core (indexers + analyzers + patch engine)",
        "foundry_mcp (MCP server that wraps foundry_core)",
        "foundry_cli (optional CLI wrapper around foundry_core)",
        "tests"
      ],
      "core_components": {
        "RepoIndexer": [
          "Detect .extension roots under repo_root",
          "Parse pyRevit bundle folders: *.tab, *.panel, *.pushbutton (and other bundle types but focus on pushbutton first)",
          "Locate scripts (script.py) and bundle.yaml per bundle",
          "Return canonical inventory JSON used by other tools"
        ],
        "CoreIndexer": [
          "Given core_root (pyRevit clone), index python packages and modules",
          "Build module->exported symbol map using AST (respect __all__ when present; else collect top-level assignments/imports)",
          "Record git sha if .git exists (shell out to git safely; if unavailable, return null)",
          "Expose evidence for wrapper suggestions: where DB/UI/forms/script/revit are defined"
        ],
        "Analyzers": {
          "ImportAuditAnalyzer": [
            "Parse selected scripts with AST",
            "Find unused imports (handle aliases)",
            "Detect raw RevitAPI imports: Autodesk.Revit.DB/UI, RevitAPI, RevitAPIUI, etc.",
            "If core index confirms existence of pyRevit wrappers (e.g., pyrevit.DB, pyrevit.UI, pyrevit.forms, pyrevit.script, pyrevit.revit), suggest replacements",
            "Return findings with line numbers, confidence, and optional patch"
          ],
          "BundleYamlAnalyzer": [
            "For bundles missing bundle.yaml, infer title/tooltip from __title__ / module docstring / header comments / folder name",
            "Generate bundle.yaml content deterministically",
            "Return patch per bundle and inferred-field confidence"
          ],
          "DuplicateCodeAnalyzer": [
            "Function-level duplicate detection across .py scripts",
            "Normalize AST (rename identifiers, normalize literals) and hash bodies",
            "Also allow near-duplicate similarity using token shingles or normalized AST string similarity",
            "Return clusters with file/function locations and confidence"
          ],
          "LibStructureSuggester": [
            "Given duplicate clusters and common helper patterns, propose a lib/ module tree",
            "Map candidate extracted functions to proposed modules (utils, io, ui, logging, etc.)",
            "Do not actually move code in V1, only propose"
          ],
          "SysPathAuditAnalyzer": [
            "Find sys.path hacks, hardcoded paths, relative path modifications",
            "Suggest consistent import strategy and warnings"
          ],
          "CompatAuditAnalyzer": [
            "Detect f-strings and other modern syntax hazards",
            "Flag usage; do not auto-rewrite f-strings unless trivial and safe (optional)"
          ]
        },
        "PatchEngine": [
          "Create unified diffs for edits",
          "Support dry-run and write modes",
          "Track patch risk levels (low/medium/high) and include summaries",
          "Never patch outside repo_root"
        ]
      }
    },
    "mcp_interface": {
      "resources": [
        {
          "name": "repo/tree",
          "returns": "Inventory JSON of extension layout"
        },
        {
          "name": "repo/file",
          "params": { "path": "string" },
          "returns": "File content"
        },
        {
          "name": "repo/py_files",
          "returns": "List of python files"
        },
        {
          "name": "core/version_info",
          "returns": "core git sha/version info if core_path provided"
        },
        {
          "name": "core/index",
          "returns": "Summary of core module/symbol index"
        }
      ],
      "tools": [
        {
          "name": "scan_extension_layout",
          "input_schema": { "repo_root": "string" },
          "output_schema": { "inventory": "object", "diagnostics": "array" }
        },
        {
          "name": "list_missing_bundle_yaml",
          "input_schema": { "repo_root": "string", "bundle_paths": "array(optional)" },
          "output_schema": { "missing": "array" }
        },
        {
          "name": "generate_bundle_yaml",
          "input_schema": { "repo_root": "string", "bundle_paths": "array(optional)", "mode": "dry_run|write(default dry_run)" },
          "output_schema": { "patches": "array(Patch)", "findings": "array(Finding)" }
        },
        {
          "name": "import_audit_with_core",
          "input_schema": { "repo_root": "string", "script_paths": "array", "core_root": "string(optional)", "allowlist": "array(optional)", "mode": "dry_run|write(default dry_run)" },
          "output_schema": { "findings": "array(Finding)", "patches": "array(Patch)", "core_version": "string|null" }
        },
        {
          "name": "analyze_duplicates",
          "input_schema": { "repo_root": "string", "script_paths": "array(optional)" },
          "output_schema": { "clusters": "array", "findings": "array(Finding)" }
        },
        {
          "name": "propose_lib_structure",
          "input_schema": { "repo_root": "string", "clusters": "array(optional)", "preferences": "object(optional)" },
          "output_schema": { "suggested_tree": "object", "mapping": "array", "findings": "array(Finding)" }
        },
        {
          "name": "apply_patch",
          "input_schema": { "repo_root": "string", "patches": "array(Patch)", "mode": "dry_run|write" },
          "output_schema": { "applied": "array", "errors": "array" }
        }
      ]
    },
    "implementation_steps": [
      "Create pyproject.toml with dependencies (AST only initially; keep minimal).",
      "Implement RepoIndexer and repo/tree resource.",
      "Implement BundleYamlAnalyzer + generate_bundle_yaml tool and list_missing_bundle_yaml.",
      "Implement CoreIndexer (pyRevit core clone indexing) + core/version_info and core/index resources.",
      "Implement ImportAuditAnalyzer with core-backed wrapper suggestions + import_audit_with_core tool.",
      "Implement DuplicateCodeAnalyzer (function-level) + analyze_duplicates tool.",
      "Implement LibStructureSuggester + propose_lib_structure tool.",
      "Implement PatchEngine + apply_patch tool; default to dry-run everywhere.",
      "Add SysPathAuditAnalyzer and CompatAuditAnalyzer as V1.1 tools.",
      "Write tests: snapshot expected patches for sample repos in tests/fixtures."
    ],
    "testing_plan": {
      "unit_tests": [
        "RepoIndexer parses bundles correctly",
        "BundleYamlAnalyzer infers title/tooltip from __title__/docstring/folder name",
        "ImportAuditAnalyzer finds unused imports and produces correct diffs",
        "CoreIndexer indexes core symbols and provides evidence links",
        "Duplicate analyzer groups exact duplicates and near-duplicates deterministically"
      ],
      "fixtures": [
        "Create a tiny fake extension repo in tests/fixtures with 2-3 bundles and scripts",
        "Create a tiny fake core clone fixture mirroring pyrevit exports (DB/UI/forms/script/revit)"
      ]
    },
    "documentation": {
      "readme_sections": [
        "What is pyRevit Foundry",
        "Quickstart (MCP + optional CLI)",
        "How to point to pyRevit core clone",
        "Examples: bundle.yaml generation, import audit, duplicates",
        "Safety model (dry-run vs write)"
      ]
    },
    "coding_constraints": [
      "Do not introduce f-strings in generated patches",
      "Keep patches minimal and reversible",
      "Prefer deterministic output (stable ordering, stable filenames)",
      "No network calls"
    ],
    "deliverables": [
      "Working MCP server exposing resources/tools above",
      "Core analysis engine usable independently",
      "Tests + fixtures",
      "README + docs"
    ]
  }
  